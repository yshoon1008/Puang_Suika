@startuml  ActivityDiagram.puml
skinparam shadowing false

start

:프레임 시작;

:입력 처리\n(Game::processEvents);
if (현재 장면 == Playing ?) then (Yes)
  :마우스 / 키보드 입력;
  :현재 푸앙의 X 위치 조정\n(getClampedMouseX\n→ Puang::radiusFor 사용);

  if (드롭 입력?) then (Yes)
    :현재 티어 푸앙 생성\n(PuangManager::spawnPuang);
    :다음 티어 생성\n(Game::generateNext);
    :드롭 사운드 재생;
  endif

  :물리 시뮬레이션 진행\n(PhysicsWorld::update);
  :모든 푸앙 상태 갱신\n(PuangManager::update → Puang::update);

  :충돌 처리\n(PuangContactListener::BeginContact);
  :같은 티어 푸앙 쌍을\nmergeQueue에 추가;

  :병합 처리\n(PuangManager::processMerges);
  repeat
    :mergeQueue에서 (p1, p2) 꺼내기;
    if (p1 또는 p2가 이미 삭제 예정?) then (Yes)
      :다음 쌍;
    else (No)
      :중간 위치 계산;
      :다음 티어 계산;
      :점수 증가;
      :p1, p2 제거 표시;
      :다음 티어 푸앙 생성\n(spawnPuang);
    endif
  repeat while (mergeQueue not empty?) is (Yes)
  -> (No);

  :isDead == true 인 푸앙 실제 삭제\n(Box2D body destroy);

  if (어떤 푸앙의 위치가\nlimit line 위로 올라감?) then (Yes)
    :게임 상태 = GameOver;
  else (No)
  endif

else (No)
  if (현재 장면 == Menu ?) then (Yes)
    :버튼 입력 확인\n(Start / Gallery);
    :장면 전환;
  else (Gallery)
    :도감 화면 렌더링;
    :뒤로가기 버튼 처리;
  endif
endif

:화면 렌더링\n(Game::render);

stop
@enduml
